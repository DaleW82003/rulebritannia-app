<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rule Britannia — Bill</title>
  <link rel="stylesheet" href="styles.css">
  <script src="app.js"></script>
</head>

<body class="theme-commons">
<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <img class="logo" src="./assets/RB%20Logo.png" alt="Rule Britannia">
    </div>

    <nav class="nav">
      <a href="dashboard.html">Office</a>
      <a href="news.html">News</a>
      <a href="papers.html">Papers</a>
      <a href="economy.html">Economy</a>
      <a href="budget.html">Budget</a>
      <a href="polling.html">Polling</a>
      <a href="questiontime.html">Question Time</a>
      <a href="motions.html">Motions</a>
      <a href="statements.html">Statements</a>
      <a href="government.html">Government</a>
      <a href="party.html">Party</a>
      <a href="civilservice.html">Civil Service</a>
      <a href="personal.html">Personal</a>
      <a href="https://forum.rulebritannia.org" target="_blank" rel="noopener">Forum</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <h1 class="page-title" id="billTitle">Loading…</h1>

  <section class="panel" id="billMeta">
    Loading bill…
  </section>

  <div class="bill-layout">
    <section class="panel">
      <h2>Bill Text</h2>
      <div class="muted-block" id="billText"></div>
    </section>

    <section class="panel">
      <h2>Amendments</h2>

      <div id="amendmentsList" class="muted-block"></div>

      <div style="margin-top:12px;">
        <a class="btn" href="#" onclick="alert('Form comes in Step 8'); return false;">Propose Amendment</a>
      </div>
    </section>
  </div>

  <section class="panel">
    <h2>Debate</h2>
    <div class="muted-block">
      Debate happens on the forum. Next step we’ll link each bill to a specific Discourse topic and embed it.
    </div>
    <div style="margin-top:12px;">
      <a class="btn" id="debateBtn" href="https://forum.rulebritannia.org" target="_blank" rel="noopener">Open Debate</a>
    </div>
  </section>
</main>

<script>
  const params = new URLSearchParams(location.search);
  const billId = params.get("id");

  const stageOrder = [
    "First Reading",
    "Second Reading",
    "Committee Stage",
    "Report Stage",
    "Division"
  ];

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  fetch("data/demo.json")
    .then(r => r.json())
    .then(data => {
      const bills = data.orderPaperCommons || [];

      // Find bill by id. If no id provided, show first bill. If id is wrong, show "not found".
      let b = null;
      if (billId) b = bills.find(x => x.id === billId);
      if (!billId && bills.length) b = bills[0];

      if (!b) {
        document.getElementById("billTitle").textContent = "Bill not found";
        document.getElementById("billMeta").innerHTML = `
          <div class="muted-block">
            This bill ID doesn’t exist. Go back to the dashboard and open a bill from the Order Paper.
          </div>
          <div style="margin-top:12px;">
            <a class="btn" href="dashboard.html">Back to Dashboard</a>
          </div>
        `;
        document.getElementById("billText").textContent = "";
        document.getElementById("amendmentsList").textContent = "";
        return;
      }

      // Title
      document.getElementById("billTitle").textContent = b.title;

      // Stage chips
      const stageChips = stageOrder.map(s => `
        <div class="stage ${b.stage === s ? "on" : ""}">${s}</div>
      `).join("");

      // Result block
      let resultBlock = "";
      if (b.status === "passed") resultBlock = `<div class="bill-result passed">Royal Assent Granted</div>`;
      else if (b.status === "failed") resultBlock = `<div class="bill-result failed">Bill Defeated</div>`;
      else resultBlock = `<div class="bill-current">Current Stage: <b>${escapeHtml(b.stage)}</b></div>`;

      // Meta panel
      document.getElementById("billMeta").innerHTML = `
        <div class="bill-title">${escapeHtml(b.title)}</div>
        <div class="bill-sub">Author: ${escapeHtml(b.author)} · ${escapeHtml(b.department)}</div>

        <div class="stage-track" style="margin-top:12px;">
          ${stageChips}
        </div>

        ${resultBlock}

        <div class="bill-actions spaced" style="margin-top:16px;">
          <a class="btn" href="dashboard.html">Back to Dashboard</a>
          <a class="btn" href="https://forum.rulebritannia.org" target="_blank" rel="noopener">Debate</a>
        </div>
      `;

      // Bill text
      const billTextEl = document.getElementById("billText");
      billTextEl.textContent = b.billText || "(No bill text added yet.)";

      // Amendments
      const amendEl = document.getElementById("amendmentsList");
      const ams = b.amendments || [];

      if (!ams.length) {
        amendEl.textContent = "No amendments proposed.";
      } else {
        amendEl.innerHTML = ams.map(a => {
          const status = (a.status || "proposed").toLowerCase();
          const supporters = Array.isArray(a.supporters) ? a.supporters.join(", ") : "None";

          return `
            <div class="amend">
              <div class="amend-top">
                <b>${escapeHtml(a.id)} — ${escapeHtml(a.title)}</b>
                <span class="tag ${escapeHtml(status)}">${escapeHtml(status)}</span>
              </div>
              <div class="amend-sub">
                Proposed by: ${escapeHtml(a.proposedBy || "Unknown")}
                · Supporters: ${escapeHtml(supporters)}
              </div>
            </div>
          `;
        }).join("");
      }

      // Debate link (placeholder)
      // Later: b.discourseTopicUrl or b.discourseTopicId
      const debateBtn = document.getElementById("debateBtn");
      if (debateBtn) debateBtn.href = "https://forum.rulebritannia.org";
    })
    .catch(err => {
      console.error(err);
      document.getElementById("billTitle").textContent = "Error loading bill";
      document.getElementById("billMeta").innerHTML = `
        <div class="muted-block">
          Couldn’t load demo data. Check that <b>data/demo.json</b> is valid JSON.
        </div>
        <div style="margin-top:12px;">
          <a class="btn" href="dashboard.html">Back to Dashboard</a>
        </div>
      `;
    });
  const t = billStageCountdown(b);
const countdownHtml = (b.status === "in-progress")
  ? `<div class="timer">
       <div class="kv"><span>${t.label}</span><b>${formatCountdown(t.msRemaining)}</b></div>
       ${typeof t.remainingSimMonths !== "undefined"
         ? `<div class="small">Sim months remaining: ${t.remainingSimMonths}</div>` : ``}
     </div>`
  : ``;
<div id="division-voting"></div>
function renderVotingUI(bill, data){

  if (bill.stage !== "Division") return;

  const players = data.players;
  const parliament = data.parliament;
  const current = data.currentPlayer;

  const weights = calculateDivisionWeights(players, parliament);

  const playerObj = players.find(p => p.name === current.name);

  if (!playerObj || !playerObj.active) return;

  const partyData = weights[playerObj.party];
  if (!partyData) return;

  let weight = 0;

  const isFrontbench = getFrontbenchRoles().includes(playerObj.role);

  if (isFrontbench) {
    weight = partyData.weightPerFull;
  } else if (playerObj.role === "backbencher" && playerObj.mature) {
    weight = partyData.weightPerFull;
  } else {
    weight = 1; // immature backbenchers
  }

  const container = document.getElementById("division-voting");

  container.innerHTML = `
    <div class="panel">
      <h3>Division</h3>
      <div class="kv"><span>Your Vote Weight:</span><b>${weight.toFixed(2)}</b></div>
      <div style="margin-top:12px;">
        <button class="btn" onclick="castVote('aye', ${weight})">Aye</button>
        <button class="btn" onclick="castVote('no', ${weight})">No</button>
        <button class="btn" onclick="castVote('abstain', ${weight})">Abstain</button>
      </div>
      <div id="division-tally" style="margin-top:12px;"></div>
    </div>
  `;
}
renderVotingUI(b, data);
function castVote(type, weight){

  const params = new URLSearchParams(location.search);
  const billId = params.get("id");

  let bills = JSON.parse(localStorage.getItem("rb_custom_bills") || "[]");

  let bill = bills.find(b => b.id === billId);

  if (!bill.division) {
    bill.division = {
      votes: { aye: 0, no: 0, abstain: 0 },
      voters: [],
      closed: false
    };
  }

  if (bill.division.voters.includes("currentUser")) return;

  bill.division.votes[type] += weight;
  bill.division.voters.push("currentUser");

  localStorage.setItem("rb_custom_bills", JSON.stringify(bills));

  updateTally(bill);
}

function updateTally(bill){
  const tally = bill.division.votes;
  document.getElementById("division-tally").innerHTML = `
    <div class="kv"><span>Aye</span><b>${tally.aye.toFixed(2)}</b></div>
    <div class="kv"><span>No</span><b>${tally.no.toFixed(2)}</b></div>
    <div class="kv"><span>Abstain</span><b>${tally.abstain.toFixed(2)}</b></div>
  `;
}
if (bill.stage === "Division" && bill.division){

  const totalCast = bill.division.votes.aye +
                    bill.division.votes.no +
                    bill.division.votes.abstain;

  const totalSeats = data.parliament.totalSeats;

  if (totalCast >= totalSeats){
    closeDivision(bill);
  }
}
function closeDivision(bill){

  if (bill.division.closed) return;

  const aye = bill.division.votes.aye;
  const no = bill.division.votes.no;

  bill.division.closed = true;

  if (aye > no){
    bill.division.result = "passed";
    autoCompleteBill(bill, true);
  } else if (no > aye){
    bill.division.result = "failed";
    autoCompleteBill(bill, false);
  } else {
    // Speaker casting vote (status quo = No)
    bill.division.result = "failed";
    autoCompleteBill(bill, false);
  }
}

function renderDivisionProgress(bill, data){

  if (!bill.division || bill.division.closed) return;

  const container = document.getElementById("division-progress");
  if (!container) return;

  const parliament = data.parliament;

  const totalSeats = parliament.totalSeats;

  const aye = bill.division.votes.aye;
  const no = bill.division.votes.no;
  const abstain = bill.division.votes.abstain;

  const totalCast = aye + no + abstain;

  const percentCast = (totalCast / totalSeats) * 100;

  const opened = new Date(bill.division.openedAt).getTime();
  const durationMs = bill.division.durationHours * 3600000;
  const now = Date.now();

  const remaining = opened + durationMs - now;

  const remainingMs = Math.max(0, remaining);

  const hours = Math.floor(remainingMs / 3600000);
  const mins = Math.floor((remainingMs % 3600000) / 60000);
  const secs = Math.floor((remainingMs % 60000) / 1000);

  const timeString = `${hours}h ${mins}m ${secs}s`;

  container.innerHTML = `
    <div style="margin-top:16px;">
      <div class="kv">
        <span>Votes Cast</span>
        <b>${percentCast.toFixed(1)}%</b>
      </div>

      <div class="progress-bar">
        <div class="progress-fill" style="width:${percentCast}%"></div>
      </div>

      <div class="kv" style="margin-top:8px;">
        <span>Time Remaining</span>
        <b>${timeString}</b>
      </div>

      <div class="kv" style="margin-top:8px;">
        <span>Aye</span><b>${aye.toFixed(2)}</b>
      </div>
      <div class="kv">
        <span>No</span><b>${no.toFixed(2)}</b>
      </div>
      <div class="kv">
        <span>Abstain</span><b>${abstain.toFixed(2)}</b>
      </div>
    </div>
  `;

  // Auto-close checks
  if (remaining <= 0 || percentCast >= 100){
    closeDivision(bill);
    location.reload();
  }
}
if (b.stage === "Division"){
  setInterval(() => {
    renderDivisionProgress(b, data);
  }, 1000);
}

</script>
</body>
</html>
